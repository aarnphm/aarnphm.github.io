@use "../../styles/variables.scss" as *;
@use "../../styles/mixin.scss" as *;

$tree-margin-y: 1.75rem;
$tree-padding-y: 1.5rem;
$tree-padding-x: 1.75rem;
$tree-border-radius: 0;
$header-margin-bottom: 1.5rem;
$step-gap: 0.85rem;
$rail-width: 1.65rem;
$connector-width: 1px;

$compact-padding-y: 1.25rem;
$compact-padding-x: 1.5rem;

$mobile-tree-margin: 1.25rem;
$mobile-tree-padding: 1.2rem;
$mobile-marker-size: 1.7rem;

.methodology-tree {
  margin: $tree-margin-y 0;
  padding: $tree-padding-y $tree-padding-x;
  border-radius: $tree-border-radius;
  border: 1px solid color-mix(in srgb, var(--gray) 28%, transparent);
  background: color-mix(in srgb, var(--light) 94%, rgba(255, 255, 255, 0));
  box-shadow: 0 18px 38px -28px color-mix(in srgb, var(--gray) 52%, rgba(0, 0, 0, 0));
  transition:
    box-shadow 0.2s ease,
    border-color 0.2s ease;

  &.compact {
    padding: $compact-padding-y $compact-padding-x;
  }

  &:hover {
    border-color: color-mix(in srgb, var(--iris) 45%, transparent);
    box-shadow: 0 18px 42px -28px color-mix(in srgb, var(--iris) 48%, rgba(0, 0, 0, 0));
  }

  .tree-header {
    padding: 0;
    display: inline-block;
    margin-bottom: $header-margin-bottom;

    & > h4 {
      font-weight: $semiBoldWeight;
      color: color-mix(in srgb, var(--secondary) 80%, var(--gray) 20%);
    }

    & > p {
      margin: 0;
      color: color-mix(in srgb, var(--gray) 78%, var(--dark) 22%);
      max-width: 62ch;
      line-height: 1.6;
    }
  }

  .tree-root {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 0;
    margin: 0;
    padding: 0;
  }

  .tree-trailing {
    margin-top: $header-margin-bottom;
    padding-top: $compact-padding-y;
    border-top: 1px solid color-mix(in srgb, var(--gray) 20%, transparent);
    display: grid;
    gap: 0.75rem;
  }
}

.methodology-step {
  position: relative;
  margin: 0;
  padding: 0;
  border: none;
  transition: background 0.2s ease;

  &:not(.is-open) .step-body {
    display: none;
  }

  .step-toggle {
    display: grid;
    grid-template-columns: $rail-width 1fr auto;
    align-items: center;
    gap: $step-gap;
    cursor: pointer;
    padding: 0;
    border-radius: 0;
    transition: background 0.2s ease;
    width: 100%;
    text-align: left;
    background: transparent;
    border: none;
    color: inherit;
    font: inherit;
    -webkit-appearance: none;
    appearance: none;
  }

  .step-header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.4rem;
    min-width: 0;
  }

  .step-title {
    font-weight: 600;
    color: var(--dark);
  }

  .step-badge {
    @include badgeCapsule(
      $bg: color-mix(in srgb, var(--gray) 12%, transparent),
      $fg: color-mix(in srgb, var(--dark) 65%, var(--gray) 35%),
      $hover-bg: color-mix(in srgb, var(--gray) 20%, transparent),
      $padding: 0.18rem 0.5rem,
      $radius: 6px,
      $font-size: 0.55rem,
      $font-family: var(--codeFont),
      $uppercase: true,
      $cursor: default,
      $border-color: color-mix(in srgb, var(--gray) 32%, transparent)
    );
    margin-left: 0.35rem;
  }

  .step-chevron {
    margin-left: auto;
    width: 0.75rem;
    height: 0.75rem;
    border: solid color-mix(in srgb, var(--gray) 65%, transparent);
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
    transition: transform 0.2s ease;
  }

  &.is-open .step-chevron {
    transform: rotate(225deg);
  }

  .step-rail {
    width: $rail-width;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0;
    pointer-events: none;
  }

  .step-line {
    width: $connector-width;
    background: color-mix(in srgb, var(--gray) 22%, transparent);
    border-radius: $connector-width;
    flex: 1;
    min-height: 0.4rem;
  }

  .step-node {
    width: 1.1rem;
    height: 1.1rem;
    border-radius: 0.45rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: color-mix(in srgb, var(--foam) 32%, transparent);
    border: 1px solid color-mix(in srgb, var(--iris) 28%, transparent);
    box-shadow: 0 6px 14px -10px color-mix(in srgb, var(--iris) 45%, transparent);
  }

  .step-sequence {
    font-size: 0.68rem;
    font-family: var(--codeFont);
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: color-mix(in srgb, var(--iris) 62%, var(--dark) 35%);
  }

  .step-body {
    display: grid;
    grid-template-columns: $rail-width 1fr;
    column-gap: $step-gap;
    padding: 0;
  }

  .step-rail--body {
    align-items: center;
    gap: 0;

    .step-line {
      min-height: calc(100% - 0.5rem);
    }
  }

  .step-body-content {
    display: grid;
    gap: 0.55rem;
  }

  .step-summary,
  .step-highlight {
    margin: 0;
    line-height: 1.6;
    color: color-mix(in srgb, var(--gray) 72%, var(--dark) 28%);
  }

  .step-summary {
    font-size: 0.9em;
    font-style: italic;
  }

  .step-highlight {
    border-left: 3px solid color-mix(in srgb, var(--iris) 60%, transparent);
    padding-left: 0.75rem;
    color: color-mix(in srgb, var(--dark) 80%, var(--iris) 20%);
    font-style: italic;
  }

  .step-points {
    margin: 0;
    padding-left: 0;
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    color: color-mix(in srgb, var(--gray) 70%, var(--dark) 30%);

    & > li {
      position: relative;
      padding-left: 1rem;

      &::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0.55em;
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 50%;
        background: color-mix(in srgb, var(--foam) 45%, transparent);
        box-shadow: 0 0 0 1px color-mix(in srgb, var(--foam) 70%, transparent);
      }
    }
  }

  .step-inline {
    display: grid;
    gap: 0.65rem;

    & > :where(blockquote, .callout) {
      margin: 0;
    }
  }
}

.methodology-children {
  display: grid;
  gap: 0.5rem;
  margin-top: 0.45rem;
}

@media all and ($mobile) {
  .methodology-tree {
    margin: $mobile-tree-margin 0;
    padding: $mobile-tree-padding;
  }

  .methodology-step {
    .step-node {
      width: $mobile-marker-size;
      height: $mobile-marker-size;
    }

    .step-sequence {
      font-size: 0.62rem;
    }
  }
}

.methodology-step:first-of-type .step-line--before {
  opacity: 0;
}

.methodology-step:last-of-type .step-line--after {
  opacity: 0;
}

.methodology-step:last-of-type .step-rail--body .step-line--body {
  opacity: 0;
}
